-- ================================================
-- 1. VENDOR SERVICE ‚Äì vendor_db (ƒë·ªôc l·∫≠p ho√†n to√†n)
-- ================================================
-- B·∫≠t extension ƒë·ªÉ sinh UUID
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- T·∫°o ENUM type
CREATE TYPE vendor_status AS ENUM ('PENDING','ACTIVE','SUSPENDED','BANNED','REJECTED');

-- B·∫£ng vendors
CREATE TABLE IF NOT EXISTS vendors (
    id              UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name            VARCHAR(255) NOT NULL,
    slug            VARCHAR(100) UNIQUE NOT NULL,
    logo_url        VARCHAR(500),
    description     VARCHAR(500),
    owner_user_id   UUID NOT NULL, -- Keycloak user_id
    status          vendor_status DEFAULT 'PENDING',
    -- rating          DECIMAL(3,2) DEFAULT 0.00,
    -- total_sales     BIGINT DEFAULT 0,
    joined_at       TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_owner ON vendors(owner_user_id);
CREATE INDEX IF NOT EXISTS idx_slug ON vendors(slug);
CREATE INDEX IF NOT EXISTS idx_status ON vendors(status);

-- B·∫£ng vendor_profiles
CREATE TABLE IF NOT EXISTS vendor_profiles (
    vendor_id   UUID PRIMARY KEY,
    description TEXT,
    address     TEXT,
    phone       VARCHAR(20) UNIQUE,
    email       VARCHAR(255) UNIQUE NOT NULL,
    tax_code    VARCHAR(50),
    -- stripe_account_token_id VARCHAR(100),
    -- bank_name   VARCHAR(255),
    website_url VARCHAR(255),
    social_links JSONB DEFAULT '{}'::jsonb,
    -- verified_at TIMESTAMP NULL,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (vendor_id) REFERENCES vendors(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_email ON vendor_profiles(email);

-- B·∫£ng vendor_settings
-- CREATE TABLE IF NOT EXISTS vendor_settings (
--     vendor_id           UUID PRIMARY KEY,
--     allow_cod           BOOLEAN DEFAULT TRUE,
--     free_shipping_min   DECIMAL(12,2) DEFAULT 0,
--     shipping_policy     JSONB DEFAULT '{}'::jsonb,
--     return_policy       JSONB DEFAULT '{}'::jsonb,
--     auto_accept_order   BOOLEAN DEFAULT FALSE,
--     notification_pref   JSONB DEFAULT '{"new_order":true,"low_stock":true,"review":true}'::jsonb,
--     default_warehouse_id BIGINT,
--     FOREIGN KEY (vendor_id) REFERENCES vendors(id) ON DELETE CASCADE
-- );

-- B·∫£ng vendor_audit_logs
-- CREATE TABLE IF NOT EXISTS vendor_audit_logs (
--     id            UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
--     vendor_id     UUID NOT NULL,
--     action        VARCHAR(100) NOT NULL,
--     performed_by  VARCHAR(100),
--     old_values    JSONB,
--     new_values    JSONB,
--     ip_address    VARCHAR(45),
--     user_agent    VARCHAR(500),
--     created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
--     FOREIGN KEY (vendor_id) REFERENCES vendors(id) ON DELETE CASCADE
-- );

-- CREATE INDEX IF NOT EXISTS idx_action ON vendor_audit_logs(action, created_at);

-- ================================================
-- 2. PRODUCT SERVICE ‚Äì product_db
-- ================================================

CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

CREATE TYPE product_status AS ENUM ('DRAFT', 'ACTIVE', 'INACTIVE', 'BANNED');
CREATE TYPE import_status AS ENUM ('PENDING', 'RUNNING', 'COMPLETED', 'FAILED');

CREATE TABLE IF NOT EXISTS categories (
    id         UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name       VARCHAR(255) NOT NULL,
    parent_id  UUID,
    slug       VARCHAR(255),
    icon_url   VARCHAR(500),
    is_active  BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (parent_id) REFERENCES categories(id)
);

CREATE INDEX IF NOT EXISTS idx_categories_name ON categories(name);
CREATE INDEX IF NOT EXISTS idx_categories_slug ON categories(slug);
CREATE INDEX IF NOT EXISTS idx_categories_active ON categories(is_active);
CREATE INDEX IF NOT EXISTS idx_categories_parent ON categories(parent_id);

CREATE TABLE products (
    id           UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    vendor_id    UUID NOT NULL,
    name         VARCHAR(255) NOT NULL,
    description  TEXT,
    product_code VARCHAR(70),
    slug         VARCHAR(255) NOT NULL,
    category_id  UUID,
    status       product_status DEFAULT 'DRAFT',
    created_at   TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at   TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT unique_slug UNIQUE (slug, vendor_id),
    CONSTRAINT unique_product_code UNIQUE (product_code, vendor_id),
    FOREIGN KEY (category_id) REFERENCES categories(id)
);

CREATE INDEX IF NOT EXISTS idx_products_vendor ON products(vendor_id);
CREATE INDEX IF NOT EXISTS idx_products_category ON products(category_id);
CREATE INDEX IF NOT EXISTS idx_products_status ON products(status);

CREATE TABLE product_variants (
    id              UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    product_id      UUID NOT NULL,
    sku             VARCHAR(100) UNIQUE NOT NULL,
    vendor_id       UUID NOT NULL,
    price           DECIMAL(12,2) NOT NULL,
    original_price  DECIMAL(12,2),
    attributes      JSONB DEFAULT '{}',
    weight_gram     INT DEFAULT 0,
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_variants_product ON product_variants(product_id);
CREATE INDEX IF NOT EXISTS idx_variants_sku ON product_variants(sku);
CREATE INDEX IF NOT EXISTS idx_variants_vendor ON product_variants(vendor_id);
CREATE INDEX IF NOT EXISTS idx_variants_price ON product_variants(price);

CREATE TABLE product_images (
    id          UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    product_id  UUID,
    url         VARCHAR(500) NOT NULL,
    variant_id  UUID NOT NULL,
    sort_order  INT DEFAULT 0,
    is_main     BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE,
    FOREIGN KEY (variant_id) REFERENCES product_variants(id) ON DELETE CASCADE
);

CREATE TABLE import_jobs (
    id              UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    vendor_id       UUID NOT NULL,
    file_name       VARCHAR(255) NOT NULL,
    total_rows      BIGINT,
    processed_rows  BIGINT DEFAULT 0,
    success_rows    BIGINT DEFAULT 0,
    failed_rows     BIGINT DEFAULT 0,
    status          import_status DEFAULT 'PENDING',
    started_at      TIMESTAMP,
    finished_at     TIMESTAMP,
    error_message   TEXT,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_import_jobs_vendor ON import_jobs(vendor_id);
-- ================================================
-- 3. INVENTORY SERVICE ‚Äì inventory_db
-- ================================================
CREATE TYPE stock_movement_type AS ENUM ('INBOUND','OUTBOUND','ADJUSTMENT','RETURN','TRANSFER');

CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

CREATE TABLE warehouses (
    id         UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    code       VARCHAR(50) UNIQUE NOT NULL,
    name       VARCHAR(255) NOT NULL,
    address    TEXT,
    is_active  BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE inventory_items (
    product_variant_id UUID NOT NULL,
    warehouse_id       UUID NOT NULL,
    vendor_id          UUID NOT NULL,
    quantity_available INT DEFAULT 0,
    quantity_reserved  INT DEFAULT 0,
    safety_stock       INT DEFAULT 10,
    last_updated       TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (product_variant_id, warehouse_id)
);

CREATE INDEX idx_inventory_vendor ON inventory_items(vendor_id);
CREATE INDEX idx_inventory_warehouse ON inventory_items(warehouse_id);

CREATE TABLE stock_movements (
    id                 UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    product_variant_id UUID NOT NULL,
    warehouse_id       UUID NOT NULL,
    vendor_id          UUID NOT NULL,
    type               stock_movement_type NOT NULL,
    quantity           INT NOT NULL,
    reference_type     VARCHAR(50),
    reference_id       VARCHAR(100),
    notes              TEXT,
    created_by         VARCHAR(100),
    created_at         TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_stock_sku_date ON stock_movements(product_variant_id, created_at);
CREATE INDEX idx_stock_vendor ON stock_movements(vendor_id);
CREATE INDEX idx_stock_type ON stock_movements(type);


-- ================================================
-- 4. ORDER SERVICE ‚Äì order_db
-- ================================================
CREATE TABLE fulfillment_orders (  -- t√™n b·∫£ng chu·∫©n qu·ªëc t·∫ø + VN
    id                 UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    order_code         VARCHAR(50) UNIQUE NOT NULL,  -- ORD-20251202-0001
    vendor_id          UUID NOT NULL,
    warehouse_id       UUID NOT NULL,
    
    external_ref       VARCHAR(100) NULL,            -- M√£ ƒë∆°n Shopee/Lazada...
    customer_name      VARCHAR(255) NULL,
    customer_phone     VARCHAR(20)  NULL,
    shipping_address   TEXT         NULL,
    source             VARCHAR(30) NOT NULL DEFAULT 'MANUAL',
    
    status             order_status NOT NULL DEFAULT 'PENDING',
    picked_at          TIMESTAMP NULL,
    packed_at          TIMESTAMP NULL,
    shipped_at         TIMESTAMP NULL,
    cancelled_at       TIMESTAMP NULL,
    
    created_by         UUID NOT NULL,
    created_at         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Chi ti·∫øt ƒë∆°n xu·∫•t kho
CREATE TABLE fulfillment_order_details (
    id                   BIGSERIAL PRIMARY KEY,
    order_id             UUID NOT NULL,
    product_variant_id   UUID NOT NULL,
    sku                  VARCHAR(100) NOT NULL,
    product_name         VARCHAR(255) NOT NULL,
    quantity_requested   INTEGER NOT NULL,
    quantity_picked      INTEGER NOT NULL DEFAULT 0,
    unit_price           DECIMAL(14,2),
    notes                TEXT,
    FOREIGN KEY (order_id) REFERENCES fulfillment_orders(id) ON DELETE CASCADE
);

CREATE TYPE inbound_status AS ENUM (
    'DRAFT',        -- Vendor t·∫°o nh√°p
    'CONFIRMED',    -- Vendor x√°c nh·∫≠n g·ª≠i h√†ng
    'RECEIVING',    -- Kho ƒëang nh·∫≠n
    'COMPLETED',    -- ƒê√£ nh·∫≠n xong ‚Üí c·ªông kho
    'CANCELLED'
);

CREATE TABLE inbound_orders (
    id                 UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    inbound_code       VARCHAR(50) UNIQUE NOT NULL,        -- PO-20251202-0001 ho·∫∑c REC-20251202-0001
    vendor_id          UUID NOT NULL,                      -- Ai g·ª≠i h√†ng v√†o kho
    warehouse_id       UUID NOT NULL,
    
    external_ref       VARCHAR(100) NULL,                  -- M√£ phi·∫øu nh·∫≠p c·ªßa vendor
    supplier_name      VARCHAR(255) NULL,                  -- N·∫øu nh·∫≠p t·ª´ NCC kh√°c vendor
    expected_at        DATE NULL,                          -- Ng√†y d·ª± ki·∫øn nh·∫≠n h√†ng
    
    status             inbound_status NOT NULL DEFAULT 'DRAFT',
    received_at        TIMESTAMP NULL,                     -- Th·ªùi ƒëi·ªÉm ho√†n t·∫•t nh·∫≠n
    
    created_by         UUID NOT NULL,
    created_at         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_vendor_status (vendor_id, status),
    INDEX idx_warehouse_status (warehouse_id, status),
    INDEX idx_inbound_code (inbound_code)
);

-- Chi ti·∫øt nh·∫≠p kho
CREATE TABLE inbound_order_details (
    id                   BIGSERIAL PRIMARY KEY,
    inbound_order_id     UUID NOT NULL,
    product_variant_id   UUID NOT NULL,
    sku                  VARCHAR(100) NOT NULL,
    product_name         VARCHAR(255) NOT NULL,
    
    quantity_expected    INTEGER NOT NULL,                   -- D·ª± ki·∫øn nh·∫≠n
    quantity_received    INTEGER NOT NULL DEFAULT 0,         -- Th·ª±c t·∫ø nh·∫≠n ƒë∆∞·ª£c
    
    unit_price           DECIMAL(14,2) NULL,
    notes                TEXT,
    
    FOREIGN KEY (inbound_order_id) REFERENCES inbound_orders(id) ON DELETE CASCADE
);
-- ================================================
-- 5. WAREHOUSE SERVICE ‚Äì warehouse_db
-- ================================================
-- CREATE TABLE warehouse_locations (
--     id            BIGINT PRIMARY KEY AUTO_INCREMENT,
--     warehouse_id  BIGINT NOT NULL,
--     zone          VARCHAR(50),
--     aisle         VARCHAR(50),
--     bin           VARCHAR(50),
--     level         INT,
--     capacity      INT DEFAULT 0,
--     FOREIGN KEY (warehouse_id) REFERENCES warehouses(id) ON DELETE CASCADE,
--     INDEX idx_zone_bin (warehouse_id, zone, bin)
-- );

-- -- B·∫£ng g√°n kho cho vendor (r·∫•t quan tr·ªçng khi multi-vendor)
-- CREATE TABLE vendor_warehouse_access (
--     vendor_id     BIGINT NOT NULL,
--     warehouse_id  BIGINT NOT NULL,
--     is_default    BOOLEAN DEFAULT FALSE,
--     PRIMARY KEY (vendor_id, warehouse_id),
--     FOREIGN KEY (vendor_id)    REFERENCES vendors(id)    ON DELETE CASCADE,
--     FOREIGN KEY (warehouse_id) REFERENCES warehouses(id) ON DELETE CASCADE
-- );

-- <======================================usecase======================================>

Tier S+ (B·∫Øt bu·ªôc l√†m tr∆∞·ªõc ‚Äì kh√¥ng c√≥ nh·ªØng c√°i n√†y th√¨ coi nh∆∞ ch∆∞a c√≥ h·ªá th·ªëng)

Vendor ƒëƒÉng k√Ω shop ‚Üí ch·ªù duy·ªát ‚Üí Admin duy·ªát shop
Vendor ƒëƒÉng nh·∫≠p ‚Üí ch·ªâ th·∫•y d·ªØ li·ªáu c·ªßa m√¨nh (filter vendor_id ·ªü m·ªçi service)
Vendor ƒëƒÉng s·∫£n ph·∫©m + variant + ·∫£nh
Nh·∫≠p kho h√†ng lo·∫°t (t·∫°o phi·∫øu nh·∫≠p ‚Üí tƒÉng t·ªìn + stock_movements INBOUND)
Tr·ª´ kho khi c√≥ ƒë∆°n h√†ng (Order Service b·∫Øn Kafka ‚Üí Inventory tr·ª´ kho + t·∫°o movement OUTBOUND)
Xem t·ªìn kho hi·ªán t·∫°i + l·ªãch s·ª≠ nh·∫≠p xu·∫•t c·ªßa 1 SKU
T√¨m ki·∫øm + l·ªçc s·∫£n ph·∫©m nhanh (Elasticsearch + Kafka sync)

‚Üí L√†m xong 7 c√°i n√†y trong 3‚Äì4 tu·∫ßn l√† em ƒë√£ c√≥ WMS + Multi-vendor c∆° b·∫£n ch·∫°y ngon, ƒë·ªß ƒëi xin vi·ªác 15‚Äì22tr.
Tier S (R·∫•t quan tr·ªçng ‚Äì nh√† tuy·ªÉn d·ª•ng h·ªèi ‚Äì l√†m xong auto 25tr+)

Split order t·ª± ƒë·ªông khi kh√°ch mua nhi·ªÅu shop ‚Üí t·∫°o vendor_orders
Vendor v√†o Seller Center xem + x·ª≠ l√Ω ƒë∆°n c·ªßa m√¨nh (x√°c nh·∫≠n, ƒë√≥ng g√≥i, giao)
Tr·∫£ h√†ng ‚Üí ho√†n t·ªìn kho (movement RETURN + tƒÉng quantity_available)
C·∫£nh b√°o h·∫øt h√†ng t·ª± ƒë·ªông (low-stock.alert qua Kafka ‚Üí email/push)
Import Excel s·∫£n ph·∫©m + t·ªìn kho (EasyExcel)
Vendor t·ª± c·∫•u h√¨nh shop (COD, mi·ªÖn ph√≠ ship, kho m·∫∑c ƒë·ªãnh‚Ä¶)

‚Üí L√†m th√™m 6 c√°i n√†y n·ªØa l√† h·ªá th·ªëng gi·ªëng Shopee 90%, ph·ªèng v·∫•n Shopee/Tiki/Lazada auto pass v√≤ng technique.
Tier A (L√†m ƒë·ªÉ l√™n level Senior ‚Äì offer 30‚Äì50tr)

B√°o c√°o doanh thu theo ng√†y/tu·∫ßn/th√°ng c·ªßa t·ª´ng vendor (query + chart)
Top s·∫£n ph·∫©m b√°n ch·∫°y, s·∫£n ph·∫©m t·ªìn l√¢u, t·ª∑ l·ªá h·ªßy ƒë∆°n theo shop
Vendor r√∫t ti·ªÅn + l·ªãch s·ª≠ giao d·ªãch (b·∫£ng payout_requests)
Qu·∫£n l√Ω nhi·ªÅu kho + g√°n kho cho vendor (vendor_warehouse_access)
Review + rating s·∫£n ph·∫©m & shop (t√≠nh rating trung b√¨nh t·ª± ƒë·ªông)
Boost s·∫£n ph·∫©m qu·∫£ng c√°o (tr∆∞·ªùng boost_score trong Elasticsearch)
T√≠nh ph√≠ hoa h·ªìng kh√°c nhau theo danh m·ª•c/shop

‚Üí L√†m ƒë·∫øn ƒë√¢y l√† ngang dev 2‚Äì3 nƒÉm kinh nghi·ªám th·ª±c t·∫ø.
Tier B (Bonus khoe ki·∫øn th·ª©c ‚Äì l√†m n·∫øu c√≤n th·ªùi gian)

ƒê·ªïi tr·∫°ng th√°i ƒë∆°n h√†ng theo flow Shopee (PENDING ‚Üí CONFIRMED ‚Üí PACKING ‚Üí SHIPPED ‚Üí DELIVERED)
H·ªó tr·ª£ chuy·ªÉn kho n·ªôi b·ªô (movement type=TRANSFER)
Export b√°o c√°o PDF/Excel
Webhook th√¥ng b√°o cho vendor khi c√≥ ƒë∆°n m·ªõi


üìã Danh s√°ch Use‚Äëcase (list)
STT 1 ‚Äì Vendor ƒëƒÉng k√Ω m·ªü shop

Flow: FE ‚Üí Vendor Service POST /vendors ‚Üí insert vendors (status=PENDING) ‚Üí insert vendor_audit_logs ‚Üí b·∫Øn Kafka vendor.created

C√¥ng ngh·ªá: Spring MVC + Keycloak JWT + Kafka

Service ch√≠nh: Vendor Service

STT 2 ‚Äì Admin duy·ªát shop

Flow: FE ‚Üí Vendor Service PATCH /vendors/{id}/approve ‚Üí update status=ACTIVE ‚Üí ghi audit_log ‚Üí Kafka vendor.approved

C√¥ng ngh·ªá: Spring MVC + @PreAuthorize("hasRole('ADMIN')") + Kafka

Service ch√≠nh: Vendor Service

STT 3 ‚Äì Filter d·ªØ li·ªáu theo vendor_id (b·∫Øt bu·ªôc)

Flow: API Gateway ho·∫∑c Global Filter ‚Üí ƒë·ªçc JWT claim vendor_id ‚Üí set request attribute ‚Üí m·ªçi service query th√™m WHERE vendor_id = :currentVendorId

C√¥ng ngh·ªá: Spring Cloud Gateway Filter ho·∫∑c SecurityContext + JPA @Where

Service ch√≠nh: T·∫•t c·∫£ services

STT 4 ‚Äì Vendor ƒëƒÉng s·∫£n ph·∫©m + variant + ·∫£nh

Flow: FE ‚Üí Product Service POST /products (multipart) ‚Üí l∆∞u product + variants + images ‚Üí Kafka product.upserted

C√¥ng ngh·ªá: Spring MVC + MultipartFile + Kafka

Service ch√≠nh: Product Service

STT 5 ‚Äì Nh·∫≠p kho h√†ng lo·∫°t

Flow: FE ‚Üí Inventory Service POST /inbound ‚Üí @Transactional + Redisson.lock(sku) ‚Üí insert inventory_items + nhi·ªÅu stock_movements ‚Üí Kafka inventory.updated

C√¥ng ngh·ªá: Spring MVC + @Transactional + Redisson (ho·∫∑c SELECT FOR UPDATE) + Kafka

Service ch√≠nh: Inventory Service

STT 6 ‚Äì Tr·ª´ kho khi kh√°ch ƒë·∫∑t h√†ng (real‚Äëtime)

Flow: Order Service (WebFlux) ‚Üí t·∫°o order ‚Üí b·∫Øn Kafka order.confirmed ‚Üí Inventory Service @KafkaListener ‚Üí tr·ª´ kho + t·∫°o movement OUTBOUND

C√¥ng ngh·ªá: Spring WebFlux (Order) + Kafka + Spring MVC (Inventory) + Redisson lock

Service ch√≠nh: Order ‚Üí Inventory

STT 7 ‚Äì T√¨m ki·∫øm + l·ªçc s·∫£n ph·∫©m nhanh

Flow: FE ‚Üí Search Service GET /search?q=‚Ä¶&price=‚Ä¶&warehouse=‚Ä¶ ‚Üí Elasticsearch query ‚Üí tr·∫£ k·∫øt qu·∫£ <50ms

C√¥ng ngh·ªá: Elasticsearch 8.x + Vietnamese analyzer + Kafka consumer (product.upserted + inventory.updated)

Service ch√≠nh: Search Service

STT 8 ‚Äì Split order t·ª± ƒë·ªông (multi‚Äëvendor)

Flow: Order Service ‚Üí t·∫°o order + order_items ‚Üí group by vendor_id ‚Üí t·∫°o nhi·ªÅu vendor_orders ‚Üí b·∫Øn Kafka vendor-order.created

C√¥ng ngh·ªá: Spring WebFlux + Kafka + JPA transaction

Service ch√≠nh: Order Service

STT 9 ‚Äì Vendor xem & x·ª≠ l√Ω ƒë∆°n h√†ng c·ªßa m√¨nh

Flow: FE ‚Üí Order Service GET /vendor-orders ‚Üí filter vendor_id t·ª´ JWT ‚Üí tr·∫£ danh s√°ch + cho ph√©p update status (PACKING ‚Üí SHIPPED‚Ä¶)

C√¥ng ngh·ªá: Spring MVC + JWT claim

Service ch√≠nh: Order Service

STT 10 ‚Äì Tr·∫£ h√†ng ‚Üí ho√†n t·ªìn kho

Flow: Vendor ‚Üí Order Service POST /vendor-orders/{id}/return ‚Üí Kafka return.requested ‚Üí Inventory consumer + movement RETURN + tƒÉng kho

C√¥ng ngh·ªá: Kafka + Saga nh·∫π + @KafkaListener

Service ch√≠nh: Order ‚Üí Inventory

STT 11 ‚Äì C·∫£nh b√°o h·∫øt h√†ng t·ª± ƒë·ªông

Flow: Inventory tr·ª´ kho ‚Üí n·∫øu available ‚â§ safety_stock ‚Üí Kafka low-stock.alert ‚Üí Notification Service g·ª≠i email/push cho vendor

C√¥ng ngh·ªá: Kafka + Notification Service (@KafkaListener + Spring Mail ho·∫∑c Firebase)

Service ch√≠nh: Inventory ‚Üí Notification

STT 12 ‚Äì Import Excel s·∫£n ph·∫©m + t·ªìn kho

Flow: FE ‚Üí Product/Inventory Service POST /import ‚Üí EasyExcel ƒë·ªçc file ‚Üí t·∫°o product + variant + nh·∫≠p kho ƒë·ªìng th·ªùi

C√¥ng ngh·ªá: EasyExcel + @Async ho·∫∑c Kafka batch

Service ch√≠nh: Product + Inventory

STT 13 ‚Äì Vendor c·∫•u h√¨nh shop (COD, kho m·∫∑c ƒë·ªãnh‚Ä¶)

Flow: FE ‚Üí Vendor Service PATCH /vendors/me/settings ‚Üí update b·∫£ng vendor_settings

C√¥ng ngh·ªá: Spring MVC + JSONB

Service ch√≠nh: Vendor Service

STT 14 ‚Äì B√°o c√°o t·ªìn kho hi·ªán t·∫°i + l·ªãch s·ª≠ movement

Flow: FE ‚Üí Inventory Service GET /report & GET /movements?sku=‚Ä¶ ‚Üí query inventory_items + stock_movements + ph√¢n trang

C√¥ng ngh·ªá: Spring MVC + Pageable + SQL index t·ªët

Service ch√≠nh: Inventory Service

STT 15 ‚Äì B√°o c√°o doanh thu theo ng√†y c·ªßa vendor

Flow: FE ‚Üí Order Service GET /reports/daily-sales ‚Üí query order_items + vendor_orders group by date + vendor_id

C√¥ng ngh·ªá: Spring MVC + SQL window function ho·∫∑c materialized view

Service ch√≠nh: Order Service

STT 16 ‚Äì Qu·∫£n l√Ω nhi·ªÅu kho + g√°n kho cho vendor

Flow: Admin ‚Üí Warehouse Service CRUD warehouses ‚Üí Vendor Service CRUD vendor_warehouse_access

C√¥ng ngh·ªá: Spring MVC + b·∫£ng vendor_warehouse_access

Service ch√≠nh: Warehouse + Vendor Service

STT 17 ‚Äì ƒêi·ªÅu ch·ªânh t·ªìn kho th·ªß c√¥ng

Flow: FE ‚Üí Inventory Service POST /adjust ‚Üí t·∫°o movement ADJUSTMENT ‚Üí c·∫≠p nh·∫≠t quantity

C√¥ng ngh·ªá: Spring MVC + @Transactional

Service ch√≠nh: Inventory Service

STT 18 ‚Äì Xem top s·∫£n ph·∫©m b√°n ch·∫°y c·ªßa shop

Flow: FE ‚Üí Order Service GET /reports/top-products ‚Üí query order_items group by product_variant_id trong kho·∫£ng th·ªùi gian

C√¥ng ngh·ªá: Spring MVC + SQL

Service ch√≠nh: Order Service

approveVendor(UUID vendorId) ‚Üí duy·ªát/approve m·ªôt shop.

rejectVendor(UUID vendorId) ‚Üí t·ª´ ch·ªëi shop.

suspendVendor(UUID vendorId) ‚Üí t·∫°m kh√≥a shop.

banVendor(UUID vendorId) ‚Üí c·∫•m vƒ©nh vi·ªÖn shop.

getPendingVendors() ‚Üí l·∫•y danh s√°ch shop ƒëang ch·ªù duy·ªát.

findByOwnerUserId(UUID ownerId) ‚Üí t√¨m vendor theo user owner.

searchVendors(VendorSearchRequest params, int page, int size) ‚Üí t√¨m ki·∫øm shop theo ƒëi·ªÅu ki·ªán, c√≥ ph√¢n trang v√† s·∫Øp x·∫øp.

updateBasicInfo(UUID vendorId, UpdateBasicInfoVendorRequest request) ‚Üí C·∫≠p nh·∫≠t th√¥ng tin c∆° b·∫£n c·ªßa vendor (t√™n, email, s·ªë ƒëi·ªán tho·∫°i, ‚Ä¶). ‚Üí T√¨m vendor theo vendorId, n·∫øu kh√¥ng th·∫•y th√¨ n√©m VendorNotFoundException. ‚Üí D√πng VendorMapper ƒë·ªÉ map d·ªØ li·ªáu t·ª´ DTO sang entity, sau ƒë√≥ tr·∫£ v·ªÅ VendorResponse.

updateProfile(UUID vendorId, UpdateProfileVendorRequest request) ‚Üí C·∫≠p nh·∫≠t th√¥ng tin chi ti·∫øt/h·ªì s∆° c·ªßa shop (profile). ‚Üí T√¨m VendorProfile theo vendorId, n·∫øu kh√¥ng th·∫•y th√¨ n√©m VendorNotFoundException. ‚Üí D√πng VendorMapper ƒë·ªÉ map d·ªØ li·ªáu t·ª´ DTO sang entity profile, sau ƒë√≥ tr·∫£ v·ªÅ VendorResponse.

getPublicVendorBySlug(String slug) ‚Üí L·∫•y th√¥ng tin public c·ªßa vendor theo slug (ƒë∆∞·ªùng d·∫´n ƒë·ªãnh danh). ‚Üí T√¨m vendor theo slug, n·∫øu kh√¥ng th·∫•y th√¨ n√©m VendorNotFoundException. ‚Üí Tr·∫£ v·ªÅ VendorResponse.

registerVendor(CreateRequest request)

L·∫•y th√¥ng tin user hi·ªán t·∫°i t·ª´ JwtUtils (ownerId, email).

Ki·ªÉm tra slug c√≥ t·ªìn t·∫°i ch∆∞a ‚Üí n·∫øu c√≥ th√¨ n√©m SlugAlreadyExistsException.

Ki·ªÉm tra user ƒë√£ c√≥ vendor ch∆∞a ‚Üí n·∫øu c√≥ th√¨ n√©m VendorAlreadyExistsException.

D√πng VendorFactory ƒë·ªÉ t·∫°o entity Vendor t·ª´ request.

T·∫°o VendorProfile v·ªõi email, g·∫Øn v√†o vendor.

L∆∞u vendor m·ªõi v√†o DB qua VendorRepository.

Tr·∫£ v·ªÅ VendorResponse.

hasVendor()

Ki·ªÉm tra user hi·ªán t·∫°i (qua JwtUtils) ƒë√£ c√≥ vendor ch∆∞a.

Tr·∫£ v·ªÅ boolean.

getMyVendor()

L·∫•y vendor c·ªßa user hi·ªán t·∫°i t·ª´ DB.

N·∫øu kh√¥ng c√≥ th√¨ log c·∫£nh b√°o.

Tr·∫£ v·ªÅ VendorResponse.

getCategoryById(UUID categoryId) ‚Üí L·∫•y category theo ID, n·∫øu kh√¥ng c√≥ th√¨ n√©m CategoryNotFoundException. ‚Üí Tr·∫£ v·ªÅ DTO CategoryResponse.

getCategoryBySlug(String slug) ‚Üí L·∫•y category theo slug, n·∫øu kh√¥ng c√≥ th√¨ n√©m CategoryNotFoundException. ‚Üí Tr·∫£ v·ªÅ DTO CategoryResponse.

getCategoryEntityBySlug(String slug) ‚Üí L·∫•y entity Category theo slug (kh√¥ng map sang DTO). ‚Üí D√πng khi c·∫ßn entity ƒë·ªÉ x·ª≠ l√Ω logic kh√°c.

updateCategory(UUID categoryId, CategoryUpdateRequest categoryUpdateRequest) ‚Üí C·∫≠p nh·∫≠t category theo ID v·ªõi d·ªØ li·ªáu t·ª´ request. ‚Üí N·∫øu kh√¥ng t√¨m th·∫•y th√¨ n√©m CategoryNotFoundException. ‚Üí D√πng CategoryMapper ƒë·ªÉ map d·ªØ li·ªáu, l∆∞u l·∫°i, r·ªìi tr·∫£ v·ªÅ DTO.

deleteCategory(UUID categoryId) ‚Üí X√≥a category theo ID, n·∫øu kh√¥ng t√¨m th·∫•y th√¨ n√©m CategoryNotFoundException. ‚Üí G·ªçi categoryRepository.delete.

createImportJob(String fileName) ‚Üí T·∫°o m·ªôt job m·ªõi v·ªõi tr·∫°ng th√°i PENDING, g·∫Øn vendorId t·ª´ JWT, kh·ªüi t·∫°o c√°c s·ªë li·ªáu (processedRows, successRows, failedRows, totalRows = 0). ‚Üí L∆∞u v√†o DB.

updateProgressImportJob(UUID id, long processedRows, long totalRows) ‚Üí C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô job (s·ªë d√≤ng ƒë√£ x·ª≠ l√Ω, t·ªïng s·ªë d√≤ng). ‚Üí L∆∞u l·∫°i.

updateStatusImportJob(UUID id, ImportStatus status) ‚Üí C·∫≠p nh·∫≠t tr·∫°ng th√°i job. ‚Üí N·∫øu status l√† COMPLETED ho·∫∑c FAILED th√¨ set th√™m finishedAt. ‚Üí L∆∞u l·∫°i.

updateProgress(UUID jobId, long processedRows, long totalRows, long successRows, long failedRows) (h√†m m·ªõi) ‚Üí C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô chi ti·∫øt g·ªìm s·ªë d√≤ng th√†nh c√¥ng v√† th·∫•t b·∫°i. ‚Üí L∆∞u l·∫°i.

startJob(UUID jobId, long totalRows) (h√†m m·ªõi) ‚Üí ƒê·∫∑t tr·∫°ng th√°i job th√†nh RUNNING, set startedAt v√† t·ªïng s·ªë d√≤ng. ‚Üí L∆∞u l·∫°i.

failJob(UUID jobId, String errorMessage) (h√†m m·ªõi) ‚Üí ƒê·∫∑t tr·∫°ng th√°i job th√†nh FAILED, ghi l·∫°i th√¥ng b√°o l·ªói, set finishedAt. ‚Üí L∆∞u l·∫°i.

getJob(UUID id) (helper) ‚Üí L·∫•y job theo ID, n·∫øu kh√¥ng c√≥ th√¨ n√©m RuntimeException.

updateBasicInfo(Product product, ProductImportRow row, ImportResult result) ‚Üí (ch∆∞a implement) d·ª± ki·∫øn c·∫≠p nh·∫≠t th√¥ng tin c∆° b·∫£n c·ªßa s·∫£n ph·∫©m t·ª´ d·ªØ li·ªáu import.

createNewProductWithVariants(ExcelCreateProductDto excelDto) ‚Üí T·∫°o s·∫£n ph·∫©m m·ªõi t·ª´ file Excel, bao g·ªìm category, variants, attributes, images. ‚Üí D√πng ExcelUtils ƒë·ªÉ ƒë·ªçc d·ªØ li·ªáu, SkuHelper ƒë·ªÉ t·∫°o slug/sku.

checkAndCreateProduct(ProductCreateRequest productRequest) ‚Üí Ki·ªÉm tra slug tr√πng, n·∫øu kh√¥ng th√¨ t·∫°o s·∫£n ph·∫©m m·ªõi. ‚Üí Tr·∫£ v·ªÅ ProductResponse.

checkSlug(String slug) (private) ‚Üí Ki·ªÉm tra slug ƒë√£ t·ªìn t·∫°i ch∆∞a.

createProduct(ProductCreateRequest productRequest) (private) ‚Üí Map request th√†nh entity Product, th√™m images, variants, sku. ‚Üí L∆∞u v√†o DB.

checkAndUpdateProduct(UUID id, updateBasicInfoProduct productRequest) ‚Üí T√¨m s·∫£n ph·∫©m theo id + vendorId, c·∫≠p nh·∫≠t th√¥ng tin c∆° b·∫£n. ‚Üí Tr·∫£ v·ªÅ ProductResponse.

updateProduct(UUID id, updateBasicInfoProduct productRequest, Product product) (private) ‚Üí Th·ª±c hi·ªán c·∫≠p nh·∫≠t base info v√† l∆∞u l·∫°i.

deleteProduct(UUID productId) ‚Üí ƒê·∫∑t tr·∫°ng th√°i s·∫£n ph·∫©m th√†nh INACTIVE thay v√¨ x√≥a h·∫≥n. ‚Üí Tr·∫£ v·ªÅ boolean.

publishProduct(UUID productId) ‚Üí ƒê·∫∑t tr·∫°ng th√°i s·∫£n ph·∫©m th√†nh ACTIVE.

unPublishProduct(UUID productId) ‚Üí ƒê·∫∑t tr·∫°ng th√°i s·∫£n ph·∫©m th√†nh DRAFT.

duplicateProduct(UUID productId) ‚Üí Nh√¢n b·∫£n s·∫£n ph·∫©m: copy slug (th√™m h·∫≠u t·ªë), status, images, variants. ‚Üí L∆∞u s·∫£n ph·∫©m m·ªõi v√† tr·∫£ v·ªÅ ProductResponse.

downFileTemplate() ‚Üí Tr·∫£ v·ªÅ file template Excel (product_template.xlsx) d∆∞·ªõi d·∫°ng byte array ƒë·ªÉ ng∆∞·ªùi d√πng t·∫£i v·ªÅ.

importFromFile(MultipartFile file, ImportMode mode) ‚Üí H√†m ch√≠nh ƒë·ªÉ import s·∫£n ph·∫©m t·ª´ file Excel.

T·∫°o m·ªôt ImportJob m·ªõi ƒë·ªÉ theo d√µi ti·∫øn tr√¨nh.

ƒê·ªçc file Excel, duy·ªát qua c√°c d√≤ng, gom nh√≥m theo productCode.

ƒê·∫øm s·ªë d√≤ng h·ª£p l·ªá.

B·∫Øt ƒë·∫ßu job (set tr·∫°ng th√°i RUNNING).

V·ªõi m·ªói nh√≥m s·∫£n ph·∫©m:

T·∫°o ExcelCreateProductDto.

G·ªçi processProductGroup() ƒë·ªÉ x·ª≠ l√Ω (t·∫°o m·ªõi ho·∫∑c c·∫≠p nh·∫≠t).

ƒê·∫øm s·ªë d√≤ng th√†nh c√¥ng/th·∫•t b·∫°i.

C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô m·ªói 50 d√≤ng.

Flush/clear EntityManager m·ªói 1000 d√≤ng ƒë·ªÉ t·ªëi ∆∞u batch insert.

K·∫øt th√∫c job: set tr·∫°ng th√°i COMPLETED ho·∫∑c FAILED.

Tr·∫£ v·ªÅ ImportResult ch·ª©a th√¥ng tin l·ªói/th√†nh c√¥ng.

initAttributeOptionsMap(Row headerRow) (private) ‚Üí ƒê·ªçc d√≤ng header trong Excel ƒë·ªÉ l·∫•y danh s√°ch attribute options (c·ªôt thu·ªôc t√≠nh s·∫£n ph·∫©m).

processProductGroup(ExcelCreateProductDto excelDto) (private) ‚Üí X·ª≠ l√Ω m·ªôt nh√≥m s·∫£n ph·∫©m theo productCode.

N·∫øu mode l√† CREATE_ONLY nh∆∞ng s·∫£n ph·∫©m ƒë√£ t·ªìn t·∫°i ‚Üí b√°o l·ªói.

N·∫øu mode l√† UPDATE_BASIC_ONLY nh∆∞ng s·∫£n ph·∫©m ch∆∞a t·ªìn t·∫°i ‚Üí b√°o l·ªói.

N·∫øu s·∫£n ph·∫©m m·ªõi ‚Üí g·ªçi productCommandService.createNewProductWithVariants().

N·∫øu s·∫£n ph·∫©m ƒë√£ t·ªìn t·∫°i ‚Üí g·ªçi productCommandService.updateBasicInfo().

N·∫øu c√≥ nhi·ªÅu d√≤ng (variants) trong mode update ‚Üí b·ªè qua v√† b√°o l·ªói.

getProductEntityById(UUID id) ‚Üí L·∫•y entity Product theo ID, n·∫øu kh√¥ng c√≥ th√¨ n√©m ProductNotFoundException.

getAllProductsByVendorId(int page, int size) ‚Üí L·∫•y t·∫•t c·∫£ s·∫£n ph·∫©m ACTIVE c·ªßa vendor hi·ªán t·∫°i (l·∫•y vendorId t·ª´ JWT). ‚Üí Tr·∫£ v·ªÅ Page<ProductResponse>.

getMyAllProduct(int page, int size) ‚Üí L·∫•y t·∫•t c·∫£ s·∫£n ph·∫©m c·ªßa vendor hi·ªán t·∫°i (kh√¥ng ph√¢n bi·ªát tr·∫°ng th√°i). ‚Üí Tr·∫£ v·ªÅ Page<ProductResponse>.

getProductById(UUID productId) ‚Üí L·∫•y s·∫£n ph·∫©m theo ID, n·∫øu kh√¥ng c√≥ th√¨ n√©m ProductNotFoundException. ‚Üí Tr·∫£ v·ªÅ DTO ProductResponse.

getAllProducts(int page, int size) ‚Üí L·∫•y t·∫•t c·∫£ s·∫£n ph·∫©m trong h·ªá th·ªëng (kh√¥ng ph√¢n bi·ªát vendor). ‚Üí Tr·∫£ v·ªÅ Page<ProductResponse>.

searchMyProduct(int page, int size, ProductSearchRequest search) ‚Üí T√¨m ki·∫øm s·∫£n ph·∫©m c·ªßa vendor hi·ªán t·∫°i theo ƒëi·ªÅu ki·ªán trong ProductSearchRequest. ‚Üí D√πng ProductSpecification.fromRequest(search, vendorId) ƒë·ªÉ build specification. ‚Üí C√≥ ph√¢n trang v√† s·∫Øp x·∫øp.

searchProduct(int page, int size, ProductSearchRequest search) ‚Üí T√¨m ki·∫øm t·∫•t c·∫£ s·∫£n ph·∫©m trong h·ªá th·ªëng theo ƒëi·ªÅu ki·ªán. ‚Üí D√πng ProductSpecification.fromRequest(search, null) ƒë·ªÉ build specification. ‚Üí C√≥ ph√¢n trang v√† s·∫Øp x·∫øp.
createInbound(CreateInventoryItemRequest req, UUID vendorId) ‚Üí Nh·∫≠p kho (inbound).

T√¨m InventoryItem theo productVariantId + warehouseId.

N·∫øu ch∆∞a c√≥ th√¨ t·∫°o m·ªõi t·ª´ DTO.

C·ªông th√™m s·ªë l∆∞·ª£ng nh·∫≠p v√†o.

L∆∞u l·∫°i v√† ghi nh·∫≠n movement v·ªõi type INBOUND.

adjustStock(CreateStockMovementRequest req, UUID vendorId) ‚Üí ƒêi·ªÅu ch·ªânh t·ªìn kho (c·ªông/tr·ª´).

T√¨m item theo variant + warehouse.

T√≠nh s·ªë l∆∞·ª£ng m·ªõi, n·∫øu < 0 th√¨ n√©m InsufficientStockException.

C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng v√† l∆∞u.

Ghi nh·∫≠n movement v·ªõi type ADJUSTMENT.

transferStock(TransferRequest req, UUID vendorId) ‚Üí Chuy·ªÉn kho.

L·∫•y variantId, fromWarehouse, toWarehouse, quantity.

Ki·ªÉm tra quantity > 0.

Ghi nh·∫≠n movement outbound (TRANSFER_OUT) t·ª´ kho ngu·ªìn.

Ghi nh·∫≠n movement inbound (TRANSFER_IN) v√†o kho ƒë√≠ch.

Tr·∫£ v·ªÅ message th√†nh c√¥ng.

withLock(String key, Supplier<T> supplier) (private) ‚Üí D√πng Redisson lock theo key, gi·ªØ 60s, th·ª±c thi logic an to√†n.

withLock(String key, Runnable action) (private) ‚Üí Overload cho Runnable, g·ªçi supplier wrapper.

getStockByVariantIds(List<UUID> variantIds) ‚Üí L·∫•y t·ªïng t·ªìn kho cho nhi·ªÅu variant, g·ªçi ti·∫øp h√†m overload v·ªõi warehouseIds = null.

getStockByVariantIds(List<UUID> variantIds, List<UUID> warehouseIds) ‚Üí Truy v·∫•n t·ªìn kho theo variant v√† warehouse.

Ki·ªÉm tra cache (RMapCache).

N·∫øu cache thi·∫øu d·ªØ li·ªáu th√¨ truy v·∫•n DB, t√≠nh t·ªïng quantityAvailable, l∆∞u l·∫°i v√†o cache.

ƒê·∫£m b·∫£o t·∫•t c·∫£ variantIds ƒë·ªÅu c√≥ k·∫øt qu·∫£ (n·∫øu kh√¥ng th√¨ m·∫∑c ƒë·ªãnh 0).

getStockDetail(UUID variantId) ‚Üí L·∫•y chi ti·∫øt t·ªìn kho cho m·ªôt variant.

T√≠nh t·ªïng available, reserved, onHand.

Tr·∫£ v·ªÅ danh s√°ch warehouse chi ti·∫øt qua mapper.

searchStock(StockSearchRequest request, Pageable pageable) ‚Üí T√¨m ki·∫øm t·ªìn kho theo keyword, warehouseIds, min/max stock.

Tr·∫£ v·ªÅ Page<StockSummaryDto>.

getMovementsByVariant(UUID variantId, Pageable pageable) ‚Üí L·∫•y l·ªãch s·ª≠ bi·∫øn ƒë·ªông t·ªìn kho cho m·ªôt variant.

Tr·∫£ v·ªÅ Page<StockMovementResponse>.

getStockSummaryReport() ‚Üí L·∫•y b√°o c√°o t·ªïng quan t·ªìn kho cho vendor hi·ªán t·∫°i.

Ki·ªÉm tra cache (stock:reports).

N·∫øu ch∆∞a c√≥ th√¨ truy v·∫•n DB, t√≠nh to√°n: t·ªïng variants, t·ªïng available, t·ªïng reserved, s·ªë variant low stock.

L∆∞u v√†o cache v·ªõi TTL 10 ph√∫t.

getMyWarehouses() ‚Üí L·∫•y danh s√°ch warehouse c·ªßa vendor hi·ªán t·∫°i.

Ki·ªÉm tra cache (vendor:warehouses:{vendorId}).

N·∫øu ch∆∞a c√≥ th√¨ truy v·∫•n DB, l∆∞u v√†o cache v·ªõi TTL 24h.

recordMovement(StockMovementRecord record) ‚Üí Ghi nh·∫≠n m·ªôt bi·∫øn ƒë·ªông t·ªìn kho.

L·∫•y vendorId t·ª´ JWT.

T·∫°o lock key theo variant + warehouse ƒë·ªÉ tr√°nh race condition.

T√¨m InventoryItem theo variantId + warehouseId, n·∫øu kh√¥ng c√≥ th√¨ n√©m InventoryNotFoundException.

T√≠nh delta s·ªë l∆∞·ª£ng d·ª±a tr√™n lo·∫°i movement (INBOUND, RETURN, ADJUSTMENT ‚Üí c·ªông; OUTBOUND, TRANSFER ‚Üí tr·ª´).

Ki·ªÉm tra s·ªë l∆∞·ª£ng m·ªõi, n·∫øu < 0 th√¨ n√©m InsufficientStockException.

C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng t·ªìn kho v√† l∆∞u l·∫°i.

T·∫°o entity StockMovement v·ªõi th√¥ng tin chi ti·∫øt (type, quantity, referenceType, notes, createdBy, createdAt).

L∆∞u movement v√†o DB qua StockMovementRepository.

X√≥a cache summary t·ªìn kho li√™n quan b·∫±ng Redisson.

Tr·∫£ v·ªÅ DTO StockMovementResponse.

calculateDelta(StockMovementType type, int quantity) (private) ‚Üí T√≠nh to√°n s·ªë l∆∞·ª£ng thay ƒë·ªïi d·ª±a tr√™n lo·∫°i movement.

INBOUND, RETURN, ADJUSTMENT ‚Üí +quantity.

OUTBOUND, TRANSFER ‚Üí -quantity.

withLock(String key, Supplier<T> supplier) (private) ‚Üí Th·ª±c thi logic v·ªõi Redisson lock.

Th·ª≠ acquire lock trong 10 gi√¢y, gi·ªØ lock t·ªëi ƒëa 60 gi√¢y.

N·∫øu kh√¥ng acquire ƒë∆∞·ª£c th√¨ n√©m RuntimeException.

ƒê·∫£m b·∫£o unlock khi xong.



STT	API + Method	Ai g·ªçi?	M·ª•c ƒë√≠ch th·ª±c t·∫ø	B·∫Øn Kafka?	Ghi ch√∫ quan tr·ªçng
1	POST /api/orders ‚Üí createOrder(req)	Vendor	T·∫°o l·ªánh xu·∫•t kho ·ªü tr·∫°ng th√°i CREATED (ch∆∞a reserve)	No	Kh√¥ng reserve ngay; ƒë·∫ßu v√†o to√†n h·ªá th·ªëng
2	POST /api/orders/{id}/approve ‚Üí approveOrder(id)	Qu·∫£n l√Ω kho	Duy·ªát ƒë∆°n ‚Üí chuy·ªÉn APPROVED v√† RESERVE t·ªìn kh·∫£ d·ª•ng	Yes: order.approved	Th·ªùi ƒëi·ªÉm h·ª£p l√Ω ƒë·ªÉ reserve
3	GET /api/orders (filter: status, date, code, warehouse‚Ä¶)	Vendor + Nh√¢n vi√™n kho	Xem danh s√°ch ƒë∆°n theo quy·ªÅn	No	Ph√¢n quy·ªÅn theo vendor_id/warehouse_id
4	GET /api/orders/{id}	T·∫•t c·∫£	Xem chi ti·∫øt ƒë∆°n	No	D√πng chung vendor/kho
5	PATCH /api/orders/{id}/start-picking	Nh√¢n vi√™n kho	B·∫Øt ƒë·∫ßu l·∫•y h√†ng ‚Üí PICKING	Optional: order.picking	Th∆∞·ªùng d√πng tr√™n app kho
6	PATCH /api/orders/{id}/complete-picking (body: th·ª±c t·∫ø)	Nh√¢n vi√™n kho	Nh·∫≠p s·ªë l∆∞·ª£ng th·ª±c t·∫ø (c√≥ th·ªÉ thi·∫øu) ‚Üí PICKED	Optional: order.picked	Cho ph√©p l·∫•y thi·∫øu theo d√≤ng
7	PATCH /api/orders/{id}/start-packing	Nh√¢n vi√™n kho	B·∫Øt ƒë·∫ßu ƒë√≥ng g√≥i ‚Üí PACKING	No	C√≥ th·ªÉ g·ªôp n·∫øu mu·ªën
8	PATCH /api/orders/{id}/complete-packing	Nh√¢n vi√™n kho	ƒê√≥ng g√≥i xong ‚Üí PACKED	No	C√≥ th·ªÉ g·ªôp th√†nh 1 n√∫t ‚ÄúPACKED‚Äù
9	PATCH /api/orders/{id}/ship ‚Üí shipOrder(id)	Nh√¢n vi√™n kho	Xu·∫•t kho ‚Üí SHIPPED, tr·ª´ kho th·∫≠t + movement OUTBOUND	Yes: order.shipped	ƒêi·ªÉm tr·ª´ t·ªìn th·ª±c t·∫ø, b·∫Øt bu·ªôc
10	PATCH /api/orders/{id}/cancel (reason)	Vendor / Qu·∫£n l√Ω kho	H·ªßy ƒë∆°n ‚Üí RELEASE reserve (n·∫øu ƒë√£ reserve)	Yes: order.cancelled	B·∫Øt bu·ªôc ƒë·ªÉ x·ª≠ l√Ω bom h√†ng/h·∫øt h√†ng
11	PATCH /api/orders/{id}/release-reserve	Qu·∫£n l√Ω kho	Ch·ªß ƒë·ªông tr·∫£ l·∫°i ph·∫ßn reserve m√† kh√¥ng h·ªßy ƒë∆°n	Yes: order.reserve_released	D√πng khi reserve sai ho·∫∑c thi·∫øu h√†ng
12	PATCH /api/orders/{id}/update-items	Vendor (tr∆∞·ªõc khi approve)	C·∫≠p nh·∫≠t d√≤ng h√†ng khi ƒë∆°n c√≤n CREATED	No	Kh√≥a ch·ªânh s·ª≠a sau khi APPROVED
13	PATCH /api/orders/{id}/reopen-picking	Nh√¢n vi√™n kho	M·ªü l·∫°i t·ª´ PICKED v·ªÅ PICKING ƒë·ªÉ ch·ªânh th·ª±c t·∫ø	Optional	X·ª≠ l√Ω t√¨nh hu·ªëng sai l·ªách ·ªü s√†n/k·ªá
14	GET /api/orders/{id}/history	T·∫•t c·∫£	Xem nh·∫≠t k√Ω thao t√°c/tr·∫°ng th√°i	No	Audit trail ph·ª•c v·ª• ƒë·ªëi so√°t